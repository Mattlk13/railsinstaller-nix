#!/bin/sh

rix_initialize()
{
  export logs=$initial_pwd/log/$timestamp
  mkdir -p "${logs}"
  rix.start
}

rix.start()
{
  trace_filter action
  log "Rails Installer uniX - preparation script - start"
  log_step "backup sm/rvm"      rix.old_install.backup
  rix.sm.install
  log_step "install rvm"        rix.rvm.install
  rix.rvm.install.ruby 1.9.2
  log_step "default 1.9.2"      rix.rvm.set.default 1.9.2
  rix.rvm.install.ruby jruby
  log_step "restore sm/rvm"     rix.old_install.restore
  log_step "cleaning old logs"  rix.clean.old.logs
  log "Rails Installer uniX - preparation script - finished"
}

rix.rvm.set.default()
{
  rvm --default use $@
}

rix.rvm.install.ruby()
{
  log_step "install ruby - $1"
  printf "\n"
  if rvm install $@
  then
    log_step success
  else
    log_step failed
  fi
}

rix.rvm.install()
{
  local __status
  pushd $rvm_local_path >/dev/null
  if ./install >$logs/install_rvm 2>&1
  then __status=0 ; else __status=$? ; fi
  popd >/dev/null
  PATH=/usr/local/rvm/bin:$PATH
  return ${__status}
}

rix.sm.install()
{
  log_step "install sm"
  export install_path=/opt/sm
  install_sm >$logs/install_sm 2>&1
  log_step_message="install sm" #TODO: fix log_step to allow building trees
  log_step success
}

rix.old_install.backup()
{
  if paths exist /opt/sm
  then paths move from /opt/sm to /opt/sm.$timestamp
  fi

  if paths exist /usr/local/rvm
  then paths move from /usr/local/rvm to /usr/local/rvm.$timestamp
  fi
}

rix.old_install.restore()
{
  paths remove /opt/sm
  if paths exist /opt/sm.$timestamp
  then paths move from /opt/sm.$timestamp to /opt/sm
  fi

  paths remove /usr/local/rvm
  if paths exist /usr/local/rvm.$timestamp
  then paths move from /usr/local/rvm.$timestamp to /usr/local/rvm
  fi
}

rix.clean.old.logs()
{
  local _log _logs_base="${logs%/*}"
  for _log in $( cd ${_logs_base} ; ls -t1 | tail +6 )
  do rm -rf ${_logs_base}/${_log}
  done
}
